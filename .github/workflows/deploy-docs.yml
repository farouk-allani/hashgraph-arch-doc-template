name: Build and Deploy Documentation

# Trigger on pushes to main branch or manual dispatch
on:
  push:
    branches:
      - main
  workflow_dispatch:

# Required for GitHub Pages deployment
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Checkout the repository code
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      # Step 2: Build HTML documentation using docker-compose
      - name: Build HTML Documentation
        run: |
          docker compose -f docker-compose-arch.yml up --no-recreate build-html
          sudo chown -R $USER:$USER build-html
      
      # Step 3: Build PDF documentation using docker-compose
      - name: Build PDF Documentation
        run: |
          docker compose -f docker-compose-arch.yml up --no-recreate build-pdf
          sudo chown -R $USER:$USER build-pdf
      
      # Step 4: Copy PDF to HTML directory for deployment
      - name: Prepare Deployment Files
        run: |
          cp build-pdf/index.pdf build-html/
      
      # Step 5: Deploy to GitHub Pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build-html
          publish_branch: gh-pages
          commit_message: "Deploy documentation ${{ github.sha }}"
